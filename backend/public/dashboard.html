<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusPay Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #0acff2;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            height: 40px;
            width: auto;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #0acff2;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .user-name {
            font-weight: 600;
            color: #ffffff;
        }

        .user-email {
            font-size: 0.8rem;
            color: #cccccc;
        }

        .logout-btn {
            background: #0acff2;
            color: #000000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #08a8c7;
            transform: translateY(-2px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .welcome-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #0acff2, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: #cccccc;
            margin-bottom: 2rem;
        }

        .developer-flow {
            background: linear-gradient(135deg, rgba(10, 207, 242, 0.1), rgba(10, 207, 242, 0.05));
            border: 2px solid rgba(10, 207, 242, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 3rem;
        }

        .flow-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0acff2;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .flow-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .flow-step {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(10, 207, 242, 0.3);
            border-radius: 12px;
            padding: 1.2rem;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .flow-step:hover {
            border-color: #0acff2;
            transform: translateY(-2px);
        }

        .flow-step-number {
            background: #0acff2;
            color: #000000;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin: 0 auto 0.8rem;
        }

        .flow-step-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .flow-step-desc {
            font-size: 0.9rem;
            color: #cccccc;
            line-height: 1.4;
        }

        .flow-arrow {
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            color: #0acff2;
            font-size: 1.5rem;
            z-index: 1;
        }

        .flow-step:last-child .flow-arrow {
            display: none;
        }

        .flow-note {
            background: rgba(10, 207, 242, 0.1);
            border-left: 4px solid #0acff2;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .flow-note-title {
            font-weight: 600;
            color: #0acff2;
            margin-bottom: 0.5rem;
        }

        .flow-note-text {
            color: #cccccc;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .paymaster-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(10, 207, 242, 0.3);
        }

        .paymaster-title {
            font-weight: 600;
            color: #0acff2;
            margin-bottom: 1rem;
        }

        .paymaster-wallets {
            display: grid;
            gap: 1rem;
        }

        .paymaster-wallet {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(10, 207, 242, 0.2);
            border-radius: 8px;
            padding: 1rem;
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .wallet-chain {
            font-weight: 600;
            color: #0acff2;
            text-transform: capitalize;
        }

        .wallet-balance {
            font-weight: 600;
            color: #51cf66;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #cccccc;
            background: rgba(0, 0, 0, 0.5);
            padding: 0.5rem;
            border-radius: 4px;
            word-break: break-all;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .wallet-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .deployment-info {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .deployment-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #0acff2;
            margin-bottom: 0.5rem;
        }

        .deployment-hash {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #888;
            background: rgba(0, 0, 0, 0.5);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            word-break: break-all;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(10, 207, 242, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #0acff2;
            box-shadow: 0 10px 30px rgba(10, 207, 242, 0.2);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0acff2;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #cccccc;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0.5rem;
        }

        .tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: #cccccc;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            background: #0acff2;
            color: #000000;
        }

        .tab:hover:not(.active) {
            background: rgba(10, 207, 242, 0.2);
            color: #0acff2;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(10, 207, 242, 0.3);
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #0acff2, #ffffff);
        }

        .project-card:hover {
            transform: translateY(-5px);
            border-color: #0acff2;
            box-shadow: 0 20px 40px rgba(10, 207, 242, 0.3);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .project-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #0acff2;
            margin-bottom: 0.5rem;
        }

        .project-id {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #888;
            background: rgba(0, 0, 0, 0.4);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            border: 1px solid rgba(10, 207, 242, 0.3);
        }

        .project-description {
            color: #cccccc;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .project-chains {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .chain-badge {
            background: linear-gradient(135deg, rgba(10, 207, 242, 0.2), rgba(10, 207, 242, 0.1));
            color: #0acff2;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            border: 1px solid rgba(10, 207, 242, 0.3);
        }

        .paymaster-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(10, 207, 242, 0.3);
        }

        .paymaster-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .paymaster-title {
            font-weight: 600;
            color: #0acff2;
            margin-bottom: 1rem;
        }

        .paymaster-wallets {
            display: grid;
            gap: 1rem;
        }

        .paymaster-wallet {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(10, 207, 242, 0.2);
            border-radius: 8px;
            padding: 1rem;
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .wallet-chain {
            font-weight: 600;
            color: #0acff2;
            text-transform: capitalize;
        }

        .wallet-balance {
            font-weight: 600;
            color: #51cf66;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #cccccc;
            background: rgba(0, 0, 0, 0.5);
            padding: 0.5rem;
            border-radius: 4px;
            word-break: break-all;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .wallet-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            background: #0acff2;
            color: #000000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn:hover {
            background: #08a8c7;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(10, 207, 242, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(10, 207, 242, 0.2);
            border-color: #0acff2;
        }

        .btn-small {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
        }

        .deployment-info {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .deployment-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #0acff2;
            margin-bottom: 0.5rem;
        }

        .deployment-hash {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #888;
            background: rgba(0, 0, 0, 0.5);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            word-break: break-all;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* API Keys Section Styles */
        .api-keys-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(10, 207, 242, 0.3);
        }

        .api-keys-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .api-keys-title {
            font-weight: 600;
            color: #0acff2;
        }

        .api-keys-list {
            display: grid;
            gap: 0.8rem;
        }

        .api-key-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(10, 207, 242, 0.2);
            border-radius: 8px;
            padding: 1rem;
        }

        .api-key-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .api-key-name {
            font-weight: 600;
            color: #ffffff;
        }

        .api-key-type {
            background: rgba(10, 207, 242, 0.2);
            color: #0acff2;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .api-key-preview-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .api-key-preview {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #cccccc;
            background: rgba(0, 0, 0, 0.5);
            padding: 0.5rem;
            border-radius: 4px;
            word-break: break-all;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1;
        }

        .api-key-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .api-key-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }

        .no-api-keys {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 2rem;
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        /* Status Badge Styles */
        .status-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .status-deployed {
            background: rgba(81, 207, 102, 0.2);
            color: #51cf66;
            border: 1px solid #51cf66;
        }

        .status-pending-funding {
            background: rgba(255, 199, 95, 0.2);
            color: #ffc75f;
            border: 1px solid #ffc75f;
            animation: pulse-warning 2s infinite;
        }

        .status-failed {
            background: rgba(250, 82, 82, 0.2);
            color: #fa5252;
            border: 1px solid #fa5252;
        }

        .status-pending {
            background: rgba(10, 207, 242, 0.2);
            color: #0acff2;
            border: 1px solid #0acff2;
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Funding Alert Styles */
        .funding-alert {
            background: rgba(255, 199, 95, 0.1);
            border: 1px solid rgba(255, 199, 95, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 0.8rem 0;
        }

        .funding-title {
            font-weight: 600;
            color: #ffc75f;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .funding-amount {
            color: #cccccc;
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
        }

        .funding-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .funding-actions .btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        /* Chain Management Styles */
        .chains-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .chain-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .chain-card:hover {
            border-color: rgba(10, 207, 242, 0.5);
            background: rgba(10, 207, 242, 0.05);
        }

        .chain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chain-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
        }

        .chain-type {
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .chain-type.evm {
            background: rgba(81, 207, 102, 0.2);
            color: #51cf66;
            border: 1px solid #51cf66;
        }

        .chain-type.svm {
            background: rgba(255, 199, 95, 0.2);
            color: #ffc75f;
            border: 1px solid #ffc75f;
        }

        .chain-details {
            display: grid;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chain-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .chain-detail-label {
            color: #888;
        }

        .chain-detail-value {
            color: #cccccc;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .chain-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .chain-feature {
            background: rgba(10, 207, 242, 0.1);
            color: #0acff2;
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            font-size: 0.7rem;
            border: 1px solid rgba(10, 207, 242, 0.3);
        }

        .project-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            margin: 5% auto;
            padding: 2rem;
            border: 1px solid #0acff2;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0acff2;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #0acff2;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #0acff2;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(10, 207, 242, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #0acff2;
            box-shadow: 0 0 0 2px rgba(10, 207, 242, 0.2);
        }

        .loading {
            text-align: center;
            color: #888;
            padding: 2rem;
        }

        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff6b6b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            color: #51cf66;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .no-projects {
            text-align: center;
            padding: 3rem;
            color: #cccccc;
        }

        .no-projects-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .create-project-btn {
            background: linear-gradient(135deg, #0acff2, #08a8c7);
            color: #000000;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .create-project-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(10, 207, 242, 0.4);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            color: #cccccc;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .checkbox-label:hover {
            background: rgba(10, 207, 242, 0.1);
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #0acff2;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .projects-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header {
                padding: 1rem;
            }
            
            .welcome-title {
                font-size: 2rem;
            }
        }

        /* Analytics Dashboard Styles */
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .analytics-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .analytics-filters select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(10, 207, 242, 0.3);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .analytics-content {
            min-height: 400px;
        }

        .analytics-loading {
            text-align: center;
            padding: 3rem;
            color: #cccccc;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(10, 207, 242, 0.3);
            border-top: 3px solid #0acff2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analytics-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(10, 207, 242, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .analytics-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0acff2;
            margin-bottom: 0.5rem;
        }

        .analytics-label {
            color: #cccccc;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .analytics-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .analytics-chart {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(10, 207, 242, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .analytics-chart h4 {
            color: #0acff2;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .analytics-table {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(10, 207, 242, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .analytics-table h4 {
            color: #0acff2;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            color: #ffffff;
        }

        .data-table th,
        .data-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(10, 207, 242, 0.2);
            color: #0acff2;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: rgba(10, 207, 242, 0.1);
        }

        .cost-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .cost-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(10, 207, 242, 0.2);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .cost-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #51cf66;
            margin-bottom: 0.5rem;
        }

        .cost-label {
            color: #cccccc;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .analytics-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .analytics-charts {
                grid-template-columns: 1fr;
            }
            
            .analytics-filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-section">
            <img src="/assets/logos/Landscape Logo@300x.png" alt="NexusPay" class="logo">
        </div>
        <div class="user-section">
            <img id="userAvatar" alt="User Avatar" class="user-avatar" style="display: none;">
            <div class="user-info">
                <div id="userName" class="user-name">Loading...</div>
                <div id="userEmail" class="user-email">Loading...</div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="welcome-section">
            <h1 class="welcome-title">NexusPay Dashboard</h1>
            <p class="welcome-subtitle">Manage your blockchain infrastructure and paymaster wallets</p>
        </div>

        <!-- Developer Flow Guide -->
        <div class="developer-flow">
            <h2 class="flow-title">🚀 5-Step Developer Integration Flow</h2>
            <div class="flow-steps">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="flow-step-title">Create Project</div>
                    <div class="flow-step-desc">Set up your project with chains and settings</div>
                    <div class="flow-arrow">→</div>
                </div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="flow-step-title">Deploy Paymasters</div>
                    <div class="flow-step-desc">Fund & deploy paymaster wallets for each chain</div>
                    <div class="flow-arrow">→</div>
                </div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="flow-step-title">Create API Key</div>
                    <div class="flow-step-desc">Generate API key tied to your project</div>
                    <div class="flow-arrow">→</div>
                </div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="flow-step-title">SDK Integration</div>
                    <div class="flow-step-desc">Use API key to connect SDK to paymasters</div>
                    <div class="flow-arrow">→</div>
                </div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="flow-step-title">Gasless Transactions</div>
                    <div class="flow-step-desc">Your paymaster pays gas fees for users</div>
                </div>
            </div>
            <div class="flow-note">
                <div class="flow-note-title">💡 How it works:</div>
                <div class="flow-note-text">
                    Your project's paymaster wallets cover gas fees for user wallet deployments and transactions. 
                    Users get gasless, seamless cross-chain experiences while you maintain full control.
                </div>
            </div>
            
            <!-- SDK Integration Guide -->
            <div style="background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(10, 207, 242, 0.3); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;">
                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem; margin-right: 0.5rem;">⚡</span>
                    <h3 style="color: #0acff2; margin: 0;">Ultra-Simple SDK Integration</h3>
                </div>
                
                <div style="background: rgba(0, 0, 0, 0.6); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="color: #888; font-size: 0.9rem; margin-bottom: 0.5rem;">npm install @nexuspay/sdk</div>
                    <div style="color: #888; font-size: 0.8rem;">Only 2 parameters needed: projectName + apiKey</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1rem;">
                        <div style="color: #0acff2; font-weight: 600; margin-bottom: 0.5rem;">🔥 Initialize (1 line)</div>
                        <code style="background: rgba(0, 0, 0, 0.8); color: #51cf66; padding: 0.5rem; border-radius: 4px; display: block; font-size: 0.8rem; overflow-x: auto;">
const nexus = new NexusSDK({
  projectName: 'YourProject',
  apiKey: 'your_api_key'
});
                        </code>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1rem;">
                        <div style="color: #0acff2; font-weight: 600; margin-bottom: 0.5rem;">💼 Create Wallet (1 line)</div>
                        <code style="background: rgba(0, 0, 0, 0.8); color: #51cf66; padding: 0.5rem; border-radius: 4px; display: block; font-size: 0.8rem; overflow-x: auto;">
const wallet = await nexus.createWallet({
  socialId: phoneNumber,
  socialType: 'phone'
});
                        </code>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; text-align: center;">
                    <span style="color: #888; font-size: 0.9rem;">🎯 That's it! Auto-gasless, cross-chain, bulletproof.</span>
                </div>
            </div>
        </div>

        <div class="dashboard-stats">
            <div class="stat-card">
                <div id="totalProjects" class="stat-number">0</div>
                <div class="stat-label">Total Projects</div>
            </div>
            <div class="stat-card">
                <div id="totalPaymasters" class="stat-number">0</div>
                <div class="stat-label">Active Paymasters</div>
            </div>
            <div class="stat-card">
                <div id="totalBalance" class="stat-number">$0</div>
                <div class="stat-label">Total Balance</div>
            </div>
            <div class="stat-card">
                <div id="totalApiKeys" class="stat-number">0</div>
                <div class="stat-label">API Keys</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('projects')">Projects</button>
            <button class="tab" onclick="showTab('create')">Create Project</button>
            <button class="tab" onclick="showTab('chains')">⛓️ Chain Management</button>
            <button class="tab" onclick="showTab('analytics')">Analytics</button>
        </div>

        <div id="projectsTab" class="tab-content active">
            <div id="projectsList" class="projects-grid">
                <div class="loading">Loading projects...</div>
            </div>
        </div>

        <div id="createTab" class="tab-content">
            <div style="max-width: 600px; margin: 0 auto; background: rgba(255, 255, 255, 0.1); padding: 2rem; border-radius: 16px; border: 1px solid rgba(10, 207, 242, 0.3);">
                <h3 style="color: #0acff2; margin-bottom: 2rem; text-align: center;">Create New Project</h3>
                
                <div id="createError" class="error" style="display: none;"></div>
                <div id="createSuccess" class="success" style="display: none;"></div>
                
                <form id="createProjectForm">
                    <div class="form-group">
                        <label class="form-label">Project Name *</label>
                        <input type="text" id="projectName" class="form-input" required placeholder="Enter project name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" id="projectDescription" class="form-input" placeholder="Brief project description">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" id="projectWebsite" class="form-input" placeholder="https://your-website.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Supported Blockchains *</label>
                        <div id="chainsCheckboxGroup" class="checkbox-group">
                            <div class="loading">Loading available chains...</div>
                        </div>
                    </div>
                    
                    <button type="submit" class="create-project-btn" id="createBtn">
                        <span>🚀</span> Create Project & Setup Paymasters
                    </button>
                </form>
            </div>
        </div>

        <div id="chainsTab" class="tab-content">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3 style="color: #0acff2; margin: 0;">⛓️ Chain Management</h3>
                    <button class="btn" onclick="showAddChainModal()">
                        ➕ Add New Chain
                    </button>
                </div>
                
                <!-- Current Supported Chains -->
                <div style="background: rgba(255, 255, 255, 0.1); padding: 2rem; border-radius: 16px; border: 1px solid rgba(10, 207, 242, 0.3); margin-bottom: 2rem;">
                    <h4 style="color: #0acff2; margin-bottom: 1.5rem;">Currently Supported Chains</h4>
                    <div id="currentChainsList" class="chains-grid">
                        <div class="loading">Loading supported chains...</div>
                    </div>
                </div>

                <!-- Chain Addition Statistics -->
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h4 style="color: #cccccc; margin-bottom: 1rem;">📊 Chain Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; color: #0acff2; font-weight: 600;" id="totalChains">3</div>
                            <div style="color: #888; font-size: 0.9rem;">Total Chains</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; color: #51cf66; font-weight: 600;" id="evmChains">2</div>
                            <div style="color: #888; font-size: 0.9rem;">EVM Chains</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; color: #ffc75f; font-weight: 600;" id="svmChains">1</div>
                            <div style="color: #888; font-size: 0.9rem;">SVM Chains</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; color: #888; font-weight: 600;" id="testnetChains">3</div>
                            <div style="color: #888; font-size: 0.9rem;">Testnet Chains</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="analyticsTab" class="tab-content">
            <div class="analytics-header">
                <h3>📊 Analytics Dashboard</h3>
                <div class="analytics-filters">
                    <select id="analyticsProject" onchange="loadProjectAnalytics()">
                        <option value="">Select Project</option>
                    </select>
                    <select id="analyticsPeriod" onchange="loadProjectAnalytics()">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                    <button class="btn btn-primary" onclick="exportAnalytics()">📥 Export Data</button>
                </div>
            </div>
            
            <div id="analyticsContent" class="analytics-content">
                <div class="analytics-loading">
                    <div class="loading-spinner"></div>
                    <p>Select a project to view analytics...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Funding Modal -->
    <div id="fundingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Fund Paymaster Wallet</h2>
                <span class="close" onclick="closeFundingModal()">&times;</span>
            </div>
            <div id="fundingContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add Chain Modal -->
    <div id="addChainModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">⛓️ Add New Chain</h2>
                <span class="close" onclick="closeAddChainModal()">&times;</span>
            </div>
            <div style="padding: 1rem 0;">
                <div id="addChainError" class="error" style="display: none;"></div>
                <div id="addChainSuccess" class="success" style="display: none;"></div>
                
                <form id="addChainForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Chain ID *</label>
                            <input type="text" id="newChainId" class="form-input" required placeholder="e.g., polygon" 
                                   pattern="^[a-z0-9_-]+$" title="Only lowercase letters, numbers, underscores, and hyphens">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Chain Type *</label>
                            <select id="newChainType" class="form-input" required>
                                <option value="">Select Type</option>
                                <option value="EVM">EVM (Ethereum Virtual Machine)</option>
                                <option value="SVM">SVM (Solana Virtual Machine)</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Display Name *</label>
                            <input type="text" id="newChainName" class="form-input" required placeholder="e.g., Polygon Mumbai">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Native Currency *</label>
                            <input type="text" id="newChainCurrency" class="form-input" required placeholder="e.g., MATIC" style="text-transform: uppercase;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">RPC URL *</label>
                        <input type="url" id="newChainRpc" class="form-input" required placeholder="https://rpc.example.com">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Chain ID Number *</label>
                            <input type="number" id="newChainIdNumber" class="form-input" required placeholder="e.g., 80001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Explorer URL</label>
                            <input type="url" id="newChainExplorer" class="form-input" placeholder="https://explorer.example.com">
                        </div>
                    </div>

                    <div style="background: rgba(255, 199, 95, 0.1); border: 1px solid rgba(255, 199, 95, 0.3); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                        <h4 style="color: #ffc75f; margin-bottom: 0.5rem;">⚠️ Important Notes</h4>
                        <ul style="color: #cccccc; font-size: 0.9rem; margin: 0; padding-left: 1.5rem;">
                            <li>New chains will be added as testnet by default</li>
                            <li>You'll need to deploy EntryPoint, WalletFactory, and Paymaster contracts</li>
                            <li>Contract addresses can be updated later through the API</li>
                            <li>All new chains require manual testing before production use</li>
                        </ul>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn-secondary btn" onclick="closeAddChainModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn" id="addChainBtn">
                            ⛓️ Add Chain
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let userProjects = [];
        let projectPaymasters = {};
        let projectApiKeys = {};

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });

        function checkAuth() {
            const token = localStorage.getItem('nexuspay_token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            fetch('/api/user/profile', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentUser = data.user;
                    updateUserInterface();
                    loadProjects();
                } else {
                    localStorage.removeItem('nexuspay_token');
                    window.location.href = '/';
                }
            })
            .catch(error => {
                console.error('Auth check failed:', error);
                localStorage.removeItem('nexuspay_token');
                window.location.href = '/';
            });
        }

        function updateUserInterface() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            
            if (currentUser.profile_picture) {
                const avatar = document.getElementById('userAvatar');
                avatar.src = currentUser.profile_picture;
                avatar.style.display = 'block';
            }
        }

        async function loadProjects() {
            const token = localStorage.getItem('nexuspay_token');
            
            try {
                console.log('🚀 Loading dashboard data with optimized API...');
                const startTime = Date.now();
                
                // Use the new optimized dashboard endpoint
                const response = await fetch('/api/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const loadTime = Date.now() - startTime;
                
                console.log(`✅ Dashboard loaded in ${loadTime}ms`);
                
                if (data && data.success && data.data) {
                    // Extract projects with pre-populated data
                    userProjects = data.data.projects || [];
                    
                    // Pre-populate project data structures from optimized response
                    projectApiKeys = {};
                    projectPaymasters = {};
                    
                    userProjects.forEach(project => {
                        // API Keys are already included
                        if (project.api_keys) {
                            projectApiKeys[project.id] = {
                                api_keys: project.api_keys,
                                total: project.api_keys.length,
                                limit: 3
                            };
                        }
                        
                        // Balances and addresses are already included
                        if (project.balances) {
                            projectPaymasters[project.id] = {
                                balances: project.balances,
                                addresses: {}
                            };
                            
                            // Extract addresses from balances
                            project.balances.forEach(balance => {
                                if (balance.address) {
                                    projectPaymasters[project.id].addresses[balance.chain] = balance.address;
                                }
                            });
                        }
                    });
                    
                    // Update stats from the optimized response
                    if (data.data.user && data.data.user.stats) {
                        const stats = data.data.user.stats;
                        
                        // Update dashboard stats
                        document.getElementById('totalProjects').textContent = stats.total_projects || 0;
                        document.getElementById('activePaymasters').textContent = stats.active_paymasters || 0;
                        document.getElementById('totalBalance').textContent = `$${(stats.total_balance_usd || 0).toFixed(2)}`;
                        document.getElementById('totalApiKeys').textContent = stats.total_api_keys || 0;
                    }
                    
                    displayProjects();
                    
                } else {
                    console.warn('Invalid dashboard data format, falling back to old method');
                    await loadProjectsFallback();
                }
                
            } catch (error) {
                console.error('Error loading optimized dashboard:', error);
                console.log('🔄 Falling back to individual API calls...');
                await loadProjectsFallback();
            }
        }

        async function loadProjectsFallback() {
            const token = localStorage.getItem('nexuspay_token');
            
            try {
                // Fallback: Load projects first
                const response = await fetch('/api/projects', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (data && data.success && data.data && Array.isArray(data.data.projects)) {
                    userProjects = data.data.projects;
                    await loadAllPaymasterDataFallback();
                } else {
                    userProjects = [];
                    displayProjects();
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading projects fallback:', error);
                userProjects = [];
                displayProjects();
                updateStats();
            }
        }

        async function loadAllPaymasterDataFallback() {
            const token = localStorage.getItem('nexuspay_token');
            
            for (const project of userProjects) {
                try {
                    const projectId = project.id || project.project_id;
                    
                    // Load paymaster balances
                    const balanceResponse = await fetch(`/api/projects/${projectId}/paymaster/balance`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (balanceResponse.ok) {
                        const balanceData = await balanceResponse.json();
                        if (balanceData.success) {
                            projectPaymasters[projectId] = balanceData.data;
                        }
                    }
                    
                    // Load paymaster addresses
                    const addressResponse = await fetch(`/api/projects/${projectId}/paymaster/addresses`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (addressResponse.ok) {
                        const addressData = await addressResponse.json();
                        if (addressData.success && projectPaymasters[projectId]) {
                            projectPaymasters[projectId].addresses = addressData.data.addresses;
                        }
                    }

                    // Load API keys
                    const apiKeysResponse = await fetch(`/api/projects/${projectId}/api-keys`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (apiKeysResponse.ok) {
                        const apiKeysData = await apiKeysResponse.json();
                        if (apiKeysData.success) {
                            projectApiKeys[projectId] = apiKeysData.data;
                        }
                    }
                } catch (error) {
                    console.error(`Error loading project data for ${projectId}:`, error);
                }
            }
            
            displayProjects();
            updateStats();
        }

        function displayProjects() {
            const projectsList = document.getElementById('projectsList');
            
            if (!userProjects || userProjects.length === 0) {
                projectsList.innerHTML = `
                    <div class="no-projects">
                        <div class="no-projects-icon">📁</div>
                        <h3>No Projects Yet</h3>
                        <p>Create your first project to get started with NexusPay</p>
                        <button class="create-project-btn" onclick="showTab('create')">
                            <span>🚀</span> Create Your First Project
                        </button>
                    </div>
                `;
                return;
            }

            projectsList.innerHTML = userProjects.map(project => {
                const paymasterData = projectPaymasters[project.id] || {};
                const totalPaymasters = project.chains ? project.chains.length : 0;
                
                return `
                    <div class="project-card">
                        <div class="project-header">
                            <div>
                                <div class="project-name">${project.name}</div>
                                <div class="project-id">${project.id}</div>
                            </div>
                        </div>
                        
                        ${project.description ? `<div class="project-description">${project.description}</div>` : ''}
                        
                        <div class="project-chains">
                            ${project.chains.map(chain => `<span class="chain-badge">${chain}</span>`).join('')}
                        </div>
                        
                        <div class="paymaster-section">
                            <div class="paymaster-title">💳 Paymaster Wallets (${totalPaymasters})</div>
                            <div class="paymaster-wallets">
                                ${project.chains.map(chain => {
                                    const chainData = paymasterData.balances ? paymasterData.balances.find(b => b.chain === chain) : null;
                                    const address = paymasterData.addresses ? paymasterData.addresses[chain] : 'Loading...';
                                    const balance = chainData ? `${chainData.balance} ${chainData.symbol}` : 'Loading...';
                                    
                                    return `
                                        <div class="paymaster-wallet">
                                            <div class="wallet-header">
                                                <div class="wallet-chain">${chain}</div>
                                                <div class="wallet-balance">${balance}</div>
                                            </div>
                                            <div class="wallet-address">${address}</div>
                                            <div class="wallet-actions">
                                                <button class="btn btn-small" onclick="fundWallet('${project.id}', '${chain}')">
                                                    💰 Fund Wallet
                                                </button>
                                                <button class="btn-secondary btn btn-small" onclick="copyAddress('${address}')">
                                                    📋 Copy
                                                </button>
                                                <button class="btn-secondary btn btn-small" onclick="refreshBalance('${project.id}', '${chain}')">
                                                    🔄 Refresh
                                                </button>
                                            </div>
                                            ${chainData && chainData.deployment_tx ? `
                                                <div class="deployment-info">
                                                    <div class="deployment-title">Deployment Transaction:</div>
                                                    <div class="deployment-hash">${chainData.deployment_tx}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <div class="api-keys-section">
                            <div class="api-keys-header">
                                <div class="api-keys-title">🔑 API Keys (${projectApiKeys[project.id] ? projectApiKeys[project.id].api_keys.length : 0}/3)</div>
                                <button class="btn btn-small" onclick="createApiKey('${project.id}')" ${projectApiKeys[project.id] && projectApiKeys[project.id].api_keys.length >= 3 ? 'disabled' : ''}>
                                    ➕ New Key
                                </button>
                            </div>
                            <div class="api-keys-list">
                                ${projectApiKeys[project.id] && projectApiKeys[project.id].api_keys.length > 0 ? 
                                    projectApiKeys[project.id].api_keys.map(apiKey => `
                                        <div class="api-key-item">
                                            <div class="api-key-header">
                                                <div class="api-key-name">${apiKey.name}</div>
                                                <div class="api-key-type">${apiKey.type}</div>
                                            </div>
                                            <div class="api-key-preview-container">
                                                <div class="api-key-preview" id="key-${apiKey.id}" title="${apiKey.key_preview}">${apiKey.key_preview}</div>
                                                <button class="btn-secondary btn btn-small" onclick="toggleKeyVisibility('${project.id}', '${apiKey.id}', this)">
                                                    👁️ Show
                                                </button>
                                            </div>
                                            <div class="api-key-info">
                                                <span class="api-key-created">Created: ${new Date(apiKey.createdAt).toLocaleDateString()}</span>
                                                <span class="api-key-last-used">${apiKey.last_used ? 'Last used: ' + new Date(apiKey.last_used).toLocaleDateString() : 'Never used'}</span>
                                            </div>
                                            <div class="api-key-actions">
                                                <button class="btn-secondary btn btn-small" onclick="copyFullApiKey('${project.id}', '${apiKey.id}', this)">
                                                    📋 Copy Full Key
                                                </button>
                                                <button class="btn-danger btn btn-small" onclick="deleteApiKey('${project.id}', '${apiKey.id}', '${apiKey.name}')">
                                                    🗑️ Delete
                                                </button>
                                            </div>
                                        </div>
                                    `).join('') 
                                    : '<div class="no-api-keys">No API keys created yet. Create your first API key to start integrating.</div>'
                                }
                            </div>
                        </div>
                        
                        <div class="project-stats">
                            <span>Created: ${new Date(project.createdAt).toLocaleDateString()}</span>
                            ${project.website ? `<a href="${project.website}" target="_blank" style="color: #0acff2;">🌐 Website</a>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load chain data if chains tab is selected
            if (tabName === 'chains') {
                loadSupportedChains();
            }
            
            // Load chains for project creation form
            if (tabName === 'create') {
                loadChainsForProjectForm();
            }
        }

        function fundWallet(projectId, chain) {
            const project = userProjects.find(p => p.id === projectId);
            const paymasterData = projectPaymasters[projectId];
            const address = paymasterData && paymasterData.addresses ? paymasterData.addresses[chain] : 'Unknown';
            
            const modal = document.getElementById('fundingModal');
            const content = document.getElementById('fundingContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <p><strong>Project:</strong> ${project.name}</p>
                    <p><strong>Chain:</strong> ${chain.charAt(0).toUpperCase() + chain.slice(1)}</p>
                    <p><strong>Wallet Address:</strong></p>
                    <div style="font-family: monospace; background: rgba(0,0,0,0.5); padding: 1rem; border-radius: 8px; word-break: break-all; margin-top: 0.5rem;">
                        ${address}
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount to Fund</label>
                    <input type="number" step="0.001" min="0" id="fundAmount" class="form-input" placeholder="Enter amount">
                    <small style="color: #888; font-size: 0.8rem; margin-top: 0.5rem; display: block;">
                        Send ${chain === 'solana' ? 'SOL' : 'ETH'} to fund gas fees
                    </small>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn" onclick="executeFunding('${projectId}', '${chain}')">
                        💰 Fund Wallet
                    </button>
                    <button class="btn-secondary btn" onclick="closeFundingModal()">
                        Cancel
                    </button>
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; background: rgba(255,255,0,0.1); border-radius: 8px; border: 1px solid rgba(255,255,0,0.3);">
                    <p style="color: #ffd43b; font-size: 0.9rem;">
                        <strong>💡 Tip:</strong> You can also send tokens directly to this address from any wallet that supports ${chain === 'solana' ? 'Solana' : 'Ethereum'}.
                    </p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeFundingModal() {
            document.getElementById('fundingModal').style.display = 'none';
        }

        function executeFunding(projectId, chain) {
            const amount = document.getElementById('fundAmount').value;
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            // This would integrate with a payment processor or wallet connection
            alert(`Funding feature coming soon! You can manually send ${amount} ${chain === 'solana' ? 'SOL' : 'ETH'} to the wallet address.`);
            closeFundingModal();
        }

        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                // Show temporary success message
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Copied';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        function refreshBalance(projectId) {
            const token = localStorage.getItem('nexuspay_token');
            
            fetch(`/api/projects/${projectId}/paymaster/refresh-balance`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadAllPaymasterData(); // Reload all data
                    
                    // Show success feedback
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '✅ Updated';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                } else {
                    alert('Failed to refresh balance');
                }
            })
            .catch(error => {
                console.error('Error refreshing balance:', error);
                alert('Error refreshing balance');
            });
        }

        // Create project form handling
        document.getElementById('createProjectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            const website = document.getElementById('projectWebsite').value.trim();
            const chains = Array.from(document.querySelectorAll('input[name="chains"]:checked')).map(cb => cb.value);
            
            if (!name) {
                showError('Project name is required');
                return;
            }
            
            if (chains.length === 0) {
                showError('Please select at least one blockchain');
                return;
            }
            
            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.textContent = '🚀 Creating Project...';
            
            const token = localStorage.getItem('nexuspay_token');
            
            fetch('/api/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    name,
                    description: description || undefined,
                    website: website || undefined,
                    chains
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pendingFunding = data.data?.pending_funding || 0;
                    const deployed = data.data?.deployed || 0;
                    
                    if (pendingFunding > 0) {
                        showSuccess(`Project created! ${pendingFunding} paymaster(s) need funding before deployment. Check the funding instructions in your project.`);
                    } else {
                        showSuccess(`Project created successfully! ${deployed} paymaster(s) deployed.`);
                    }
                    
                    document.getElementById('createProjectForm').reset();
                    setTimeout(() => {
                        loadProjects();
                        showTab('projects');
                    }, 2000);
                } else {
                    showError(data.error ? data.error.message : 'Failed to create project');
                }
            })
            .catch(error => {
                console.error('Error creating project:', error);
                showError('Network error occurred');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<span>🚀</span> Create Project & Setup Paymasters';
            });
        });

        function showError(message) {
            const errorDiv = document.getElementById('createError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('createSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('nexuspay_token');
            window.location.href = '/';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const fundingModal = document.getElementById('fundingModal');
            const addChainModal = document.getElementById('addChainModal');
            
            if (event.target === fundingModal) {
                closeFundingModal();
            }
            if (event.target === addChainModal) {
                closeAddChainModal();
            }
        }

        // Enhanced functions for paymaster management
        async function loadAllPaymasterData() {
            const token = localStorage.getItem('nexuspay_token');
            
            for (const project of userProjects) {
                try {
                    const projectId = project.id || project.project_id;
                    
                    // Load paymaster balances
                    const balanceResponse = await fetch(`/api/projects/${projectId}/paymaster/balance`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (balanceResponse.ok) {
                        const balanceData = await balanceResponse.json();
                        if (balanceData.success) {
                            projectPaymasters[projectId] = balanceData.data;
                        }
                    }
                    
                    // Load paymaster addresses
                    const addressResponse = await fetch(`/api/projects/${projectId}/paymaster/addresses`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (addressResponse.ok) {
                        const addressData = await addressResponse.json();
                        if (addressData.success && projectPaymasters[projectId]) {
                            projectPaymasters[projectId].addresses = addressData.data.addresses;
                        }
                    }

                    // Load API keys
                    const apiKeysResponse = await fetch(`/api/projects/${projectId}/api-keys`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (apiKeysResponse.ok) {
                        const apiKeysData = await apiKeysResponse.json();
                        if (apiKeysData.success) {
                            projectApiKeys[projectId] = apiKeysData.data;
                        }
                    }
                } catch (error) {
                    console.error(`Error loading project data for ${projectId}:`, error);
                }
            }
            
            displayProjects();
            updateStats();
        }

        function displayProjects() {
            const projectsList = document.getElementById('projectsList');
            
            if (!userProjects || !Array.isArray(userProjects) || userProjects.length === 0) {
                projectsList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #cccccc;">
                        <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">📁</div>
                        <h3>No Projects Yet</h3>
                        <p>Create your first project to get started with NexusPay</p>
                        <button class="create-project-btn" onclick="showTab('create')">
                            <span>🚀</span> Create Your First Project
                        </button>
                    </div>
                `;
                return;
            }

            projectsList.innerHTML = userProjects.map(project => {
                const projectId = project.id || project.project_id;
                const paymasterData = projectPaymasters[projectId] || {};
                
                return `
                <div class="project-card">
                    <div class="project-header">
                        <div>
                            <div class="project-name">${project.name || 'Unnamed Project'}</div>
                            <div class="project-id">${projectId || 'No ID'}</div>
                        </div>
                    </div>
                    
                    ${project.description ? `<div class="project-description">${project.description}</div>` : ''}
                    
                    <div class="project-chains">
                        ${(project.chains || []).map(chain => `<span class="chain-badge">${chain}</span>`).join('')}
                    </div>
                    
                    <div class="paymaster-section">
                        <div class="paymaster-title">💳 Paymaster Wallets (${project.chains ? project.chains.length : 0})</div>
                        <div class="paymaster-wallets">
                            ${(project.chains || []).map(chain => {
                                const chainData = paymasterData.balances ? paymasterData.balances.find(b => b.chain === chain) : null;
                                const address = paymasterData.addresses ? paymasterData.addresses[chain] : 'Loading...';
                                const balance = chainData ? `${parseFloat(chainData.balance || 0).toFixed(4)} ${chainData.symbol || 'ETH'}` : 'Loading...';
                                const balanceUSD = chainData && chainData.balance_usd ? `($${parseFloat(chainData.balance_usd).toFixed(2)})` : '';
                                
                                // Get deployment status and funding info
                                const deploymentStatus = chainData?.deployment_status || 'unknown';
                                const fundingRequired = chainData?.funding_required || false;
                                const fundingInstructions = chainData?.funding_instructions;
                                
                                // Status badge styling
                                const statusBadge = getStatusBadge(deploymentStatus);
                                
                                return `
                                    <div class="paymaster-wallet">
                                        <div class="wallet-header">
                                            <div class="wallet-chain">${chain}</div>
                                            <div class="wallet-balance">${balance} ${balanceUSD}</div>
                                            ${statusBadge}
                                        </div>
                                        <div class="wallet-address" title="${address}">${address}</div>
                                        
                                        ${fundingRequired && fundingInstructions ? `
                                            <div class="funding-alert">
                                                <div class="funding-title">⚠️ Funding Required</div>
                                                <div class="funding-amount">Send <strong>${fundingInstructions.required_amount}</strong> to activate paymaster</div>
                                                <div class="funding-actions">
                                                    <button class="btn btn-small" onclick="copyAddress('${fundingInstructions.funding_address}')">
                                                        📋 Copy Address
                                                    </button>
                                                    <a href="${fundingInstructions.faucet_url}" target="_blank" class="btn-secondary btn btn-small">
                                                        🚰 Get Testnet Funds
                                                    </a>
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        <div class="wallet-actions">
                                            ${deploymentStatus === 'pending_funding' ? `
                                                <button class="btn btn-small" onclick="retryDeployment('${projectId}')">
                                                    🔄 Retry Deployment
                                                </button>
                                            ` : ''}
                                            
                                            ${deploymentStatus === 'deployed' ? `
                                                <button class="btn btn-small" onclick="addFunds('${projectId}', '${chain}', '${address}')">
                                                    💰 Add Funds
                                                </button>
                                            ` : ''}
                                            
                                            <button class="btn-secondary btn btn-small" onclick="copyAddress('${address}')">
                                                📋 Copy Address
                                            </button>
                                            <button class="btn-secondary btn btn-small" onclick="refreshBalance('${projectId}')">
                                                🔄 Refresh
                                            </button>
                                        </div>
                                        
                                        ${chainData && chainData.deployment_tx && deploymentStatus === 'deployed' ? `
                                            <div class="deployment-info">
                                                <div class="deployment-title">📊 Deployment Transaction:</div>
                                                <div class="deployment-hash" title="${chainData.deployment_tx}">
                                                    <a href="${getExplorerLink(chain, chainData.deployment_tx)}" target="_blank" style="color: #0acff2; text-decoration: none;">
                                                        ${chainData.deployment_tx.substring(0, 10)}...${chainData.deployment_tx.substring(chainData.deployment_tx.length - 8)}
                                                    </a>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="project-actions" style="margin-bottom: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button class="btn-secondary btn btn-small" onclick="manageProjectSettings('${projectId}', '${project.name}')">
                            ⚙️ Settings
                        </button>
                    </div>
                    
                    <div class="api-keys-section">
                        <div class="api-keys-header">
                            <div class="api-keys-title">🔑 API Keys (${projectApiKeys[projectId] ? projectApiKeys[projectId].api_keys.length : 0}/3)</div>
                            <button class="btn btn-small" onclick="createApiKey('${projectId}')" ${projectApiKeys[projectId] && projectApiKeys[projectId].api_keys.length >= 3 ? 'disabled' : ''}>
                                ➕ New Key
                            </button>
                        </div>
                        <div class="api-keys-list">
                            ${projectApiKeys[projectId] && projectApiKeys[projectId].api_keys.length > 0 ? 
                                projectApiKeys[projectId].api_keys.map(apiKey => `
                                    <div class="api-key-item">
                                        <div class="api-key-header">
                                            <div class="api-key-name">${apiKey.name}</div>
                                            <div class="api-key-type">${apiKey.type}</div>
                                        </div>
                                        <div class="api-key-preview-container">
                                            <div class="api-key-preview" id="key-${apiKey.id}" title="${apiKey.key_preview}">${apiKey.key_preview}</div>
                                            <button class="btn-secondary btn btn-small" onclick="toggleKeyVisibility('${projectId}', '${apiKey.id}', this)">
                                                👁️ Show
                                            </button>
                                        </div>
                                        <div class="api-key-info">
                                            <span class="api-key-created">Created: ${new Date(apiKey.createdAt).toLocaleDateString()}</span>
                                            <span class="api-key-last-used">${apiKey.last_used_at ? 'Last used: ' + new Date(apiKey.last_used_at).toLocaleDateString() : 'Never used'}</span>
                                            <span class="api-key-usage">Usage: ${apiKey.usage_count || 0} requests</span>
                                        </div>
                                        <div class="api-key-security-info" style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            ${apiKey.ip_whitelist && apiKey.ip_whitelist.length > 0 ? 
                                                `<span style="background: rgba(81, 207, 102, 0.2); color: #51cf66; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; border: 1px solid #51cf66;">
                                                    🛡️ IP Protected (${apiKey.ip_whitelist.length})
                                                </span>` : 
                                                `<span style="background: rgba(255, 199, 95, 0.2); color: #ffc75f; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; border: 1px solid #ffc75f;">
                                                    🌐 No IP Restrictions
                                                </span>`
                                            }
                                            <span style="background: rgba(10, 207, 242, 0.2); color: #0acff2; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; border: 1px solid #0acff2;">
                                                ${apiKey.permissions ? apiKey.permissions.length : 3} permissions
                                            </span>
                                            ${apiKey.status === 'rotated' ? 
                                                `<span style="background: rgba(255, 199, 95, 0.2); color: #ffc75f; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; border: 1px solid #ffc75f;">
                                                    🔄 Recently Rotated
                                                </span>` : ''
                                            }
                                        </div>
                                        <div class="api-key-actions">
                                            <button class="btn-secondary btn btn-small" onclick="copyFullApiKey('${projectId}', '${apiKey.id}', this)">
                                                📋 Copy Full Key
                                            </button>
                                            <button class="btn btn-small" onclick="showUsageAnalytics('${projectId}', '${apiKey.id}', '${apiKey.name}')">
                                                📊 Usage
                                            </button>
                                            <button class="btn btn-small" onclick="manageIPWhitelist('${projectId}', '${apiKey.id}', '${apiKey.name}')">
                                                🛡️ IP Whitelist
                                            </button>
                                            <button class="btn btn-small" onclick="rotateApiKey('${projectId}', '${apiKey.id}', '${apiKey.name}')">
                                                🔄 Rotate
                                            </button>
                                            <button class="btn-danger btn btn-small" onclick="deleteApiKey('${projectId}', '${apiKey.id}', '${apiKey.name}')">
                                                🗑️ Delete
                                            </button>
                                        </div>
                                    </div>
                                `).join('') 
                                : '<div class="no-api-keys">No API keys created yet. Create your first API key to start integrating.</div>'
                            }
                        </div>
                    </div>
                    
                    <div class="project-stats">
                        <span>Created: ${project.createdAt || project.created_at ? new Date(project.createdAt || project.created_at).toLocaleDateString() : 'Unknown'}</span>
                        ${project.website ? `<span>• <a href="${project.website}" target="_blank" style="color: #0acff2;">🌐 Website</a></span>` : ''}
                    </div>
                </div>
            `;
            }).join('');
        }

        function updateStats() {
            document.getElementById('totalProjects').textContent = userProjects.length;
            
            let totalPaymasters = 0;
            let totalBalanceUSD = 0;
            let totalApiKeys = 0;
            
            userProjects.forEach(project => {
                const projectId = project.id || project.project_id;
                
                totalPaymasters += project.chains ? project.chains.length : 0;
                
                const paymasterData = projectPaymasters[projectId];
                if (paymasterData && paymasterData.balances) {
                    paymasterData.balances.forEach(balance => {
                        totalBalanceUSD += parseFloat(balance.balance_usd) || 0;
                    });
                }

                const apiKeyData = projectApiKeys[projectId];
                if (apiKeyData && apiKeyData.api_keys) {
                    totalApiKeys += apiKeyData.api_keys.length;
                }
            });
            
            document.getElementById('totalPaymasters').textContent = totalPaymasters;
            document.getElementById('totalBalance').textContent = `$${totalBalanceUSD.toFixed(2)}`;
            document.getElementById('totalApiKeys').textContent = totalApiKeys;
        }

        function getExplorerLink(chain, txHash) {
            const explorers = {
                ethereum: `https://sepolia.etherscan.io/tx/${txHash}`,
                arbitrum: `https://sepolia.arbiscan.io/tx/${txHash}`,
                solana: `https://explorer.solana.com/tx/${txHash}?cluster=devnet`
            };
            return explorers[chain] || '#';
        }

        // Status Badge Function
        function getStatusBadge(deploymentStatus) {
            const statusConfig = {
                'deployed': { icon: '✅', text: 'Deployed', class: 'status-deployed' },
                'pending_funding': { icon: '⚠️', text: 'Needs Funding', class: 'status-pending-funding' },
                'pending': { icon: '⏳', text: 'Deploying', class: 'status-pending' },
                'failed': { icon: '❌', text: 'Failed', class: 'status-failed' },
                'unknown': { icon: '❓', text: 'Unknown', class: 'status-pending' }
            };
            
            const config = statusConfig[deploymentStatus] || statusConfig['unknown'];
            return `<div class="status-badge ${config.class}">${config.icon} ${config.text}</div>`;
        }

        // Retry Deployment Function
        function retryDeployment(projectId) {
            const token = localStorage.getItem('nexuspay_token');
            
            // Show confirmation
            if (!confirm('Retry deployment for paymasters that need funding?\n\nMake sure you have funded the required wallet addresses first.')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '⏳ Retrying...';
            button.disabled = true;
            
            fetch(`/api/projects/${projectId}/paymaster/deploy`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ Deployment retry completed!\n\n${data.message}\n\nDeployed: ${data.data.deployed}\nStill pending: ${data.data.pending_funding}`);
                    loadAllPaymasterData(); // Reload to show updated status
                } else {
                    alert(`❌ Deployment retry failed: ${data.error ? data.error.message : 'Unknown error'}`);
                }
                
                button.textContent = originalText;
                button.disabled = false;
            })
            .catch(error => {
                console.error('Error retrying deployment:', error);
                alert('❌ Error retrying deployment');
                button.textContent = originalText;
                button.disabled = false;
            });
        }

        // Add Funds Function (for deployed paymasters)
        function addFunds(projectId, chain, address) {
            const amount = prompt(`How much ${chain === 'solana' ? 'SOL' : 'ETH'} would you like to add to your ${chain} paymaster?\n\nWallet: ${address}\n\nEnter amount:`);
            
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                return;
            }
            
            const confirmMessage = `Send ${amount} ${chain === 'solana' ? 'SOL' : 'ETH'} to:\n\n${address}\n\nPlease send this transaction manually and click OK when done.`;
            
            if (confirm(confirmMessage)) {
                // Copy address to clipboard for convenience
                copyAddress(address);
                alert('Address copied to clipboard!\n\nAfter sending funds, click "Refresh" to update the balance.');
            }
        }

        // API Key Management Functions
        function createApiKey(projectId) {
            const keyName = prompt('Enter a name for this API key:');
            if (!keyName || !keyName.trim()) {
                return;
            }

            const keyType = prompt('Enter key type (dev, production, restricted):', 'production');
            const validTypes = ['dev', 'production', 'restricted'];
            if (!validTypes.includes(keyType)) {
                alert('Invalid key type. Must be dev, production, or restricted');
                return;
            }

            const token = localStorage.getItem('nexuspay_token');
            
            fetch(`/api/projects/${projectId}/api-keys`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    name: keyName.trim(),
                    type: keyType,
                    permissions: ['wallets:create', 'wallets:deploy', 'wallets:read']
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`API Key created successfully!\n\nKey: ${data.data.api_key.key}\n\n⚠️ WARNING: Save this key securely - it won't be shown again!`);
                    loadAllPaymasterData(); // Reload to show new key
                } else {
                    alert(`Failed to create API key: ${data.error ? data.error.message : 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error creating API key:', error);
                alert('Error creating API key');
            });
        }

        function copyFullApiKey(projectId, keyId, buttonElement) {
            const token = localStorage.getItem('nexuspay_token');
            const originalText = buttonElement.textContent;
            
            // Show loading state
            buttonElement.textContent = '⏳ Loading...';
            buttonElement.disabled = true;
            
            fetch(`/api/projects/${projectId}/api-keys/${keyId}/reveal`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Copy the full API key to clipboard
                    navigator.clipboard.writeText(data.data.key).then(() => {
                        buttonElement.textContent = '✅ Copied!';
                        setTimeout(() => {
                            buttonElement.textContent = originalText;
                            buttonElement.disabled = false;
                        }, 2000);
                    }).catch(() => {
                        alert('Failed to copy to clipboard. Please try again.');
                        buttonElement.textContent = originalText;
                        buttonElement.disabled = false;
                    });
                } else {
                    alert(`Failed to get API key: ${data.error ? data.error.message : 'Unknown error'}`);
                    buttonElement.textContent = originalText;
                    buttonElement.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error revealing API key:', error);
                alert('Error retrieving API key');
                buttonElement.textContent = originalText;
                buttonElement.disabled = false;
            });
        }

        function toggleKeyVisibility(projectId, keyId, buttonElement) {
            const keyPreviewElement = document.getElementById(`key-${keyId}`);
            const token = localStorage.getItem('nexuspay_token');
            
            // If currently showing preview, fetch and show full key
            if (buttonElement.textContent.includes('Show')) {
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '⏳ Loading...';
                buttonElement.disabled = true;
                
                // Store original preview for later restoration
                if (!keyPreviewElement.dataset.originalPreview) {
                    keyPreviewElement.dataset.originalPreview = keyPreviewElement.textContent;
                }
                
                fetch(`/api/projects/${projectId}/api-keys/${keyId}/reveal`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        keyPreviewElement.textContent = data.data.key;
                        keyPreviewElement.title = data.data.key;
                        buttonElement.textContent = '🙈 Hide';
                        buttonElement.disabled = false;
                    } else {
                        alert(`Failed to get API key: ${data.error ? data.error.message : 'Unknown error'}`);
                        buttonElement.textContent = originalText;
                        buttonElement.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error revealing API key:', error);
                    alert('Error retrieving API key');
                    buttonElement.textContent = originalText;
                    buttonElement.disabled = false;
                });
            } else {
                // Currently showing full key, switch back to preview
                const originalPreview = keyPreviewElement.dataset.originalPreview;
                keyPreviewElement.textContent = originalPreview;
                keyPreviewElement.title = originalPreview;
                buttonElement.textContent = '👁️ Show';
            }
        }

        function deleteApiKey(projectId, keyId, keyName) {
            if (!confirm(`Are you sure you want to delete the API key "${keyName}"?\n\nThis action cannot be undone and will immediately revoke access for this key.`)) {
                return;
            }

            const token = localStorage.getItem('nexuspay_token');
            
            fetch(`/api/projects/${projectId}/api-keys/${keyId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('API key deleted successfully');
                    loadAllPaymasterData(); // Reload to remove deleted key
                } else {
                    alert(`Failed to delete API key: ${data.error ? data.error.message : 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error deleting API key:', error);
                alert('Error deleting API key');
            });
        }

        function rotateApiKey(projectId, keyId, keyName) {
            if (!confirm(`Rotate API key "${keyName}"?\n\n⚠️ This will generate a new key and the old key will expire in 24 hours.\n\nMake sure to update your applications with the new key within 24 hours.`)) {
                return;
            }

            const token = localStorage.getItem('nexuspay_token');
            
            fetch(`/api/projects/${projectId}/api-keys/${keyId}/rotate`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`API Key rotated successfully!\n\n🔑 NEW KEY: ${data.data.new_key}\n\n⏰ Old key expires: ${new Date(data.data.old_key_expires).toLocaleString()}\n\n⚠️ UPDATE YOUR APPLICATIONS WITHIN 24 HOURS!\n\nSave this key securely - it won't be shown again!`);
                    loadAllPaymasterData(); // Reload to show new key
                } else {
                    alert(`Failed to rotate API key: ${data.error ? data.error.message : 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error rotating API key:', error);
                alert('Error rotating API key');
            });
        }

        function showUsageAnalytics(projectId, keyId, keyName) {
            const token = localStorage.getItem('nexuspay_token');
            
            // Show loading modal
            const modal = document.createElement('div');
            modal.id = 'usageAnalyticsModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="closeUsageModal(event)">
                    <div style="background: #1a1a1a; border: 2px solid #0acff2; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="color: #0acff2; margin: 0;">📊 Usage Analytics: ${keyName}</h3>
                            <button onclick="closeUsageModal()" style="background: #0acff2; color: black; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer;">✕ Close</button>
                        </div>
                        <div id="usage-content" style="color: #ffffff;">
                            <div style="text-align: center; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
                                <div>Loading usage analytics...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            fetch(`/api/projects/${projectId}/api-keys/${keyId}/usage`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const usage = data.data.usage;
                    document.getElementById('usage-content').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: rgba(10, 207, 242, 0.1); border: 1px solid #0acff2; border-radius: 8px; padding: 1rem; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 600; color: #0acff2;">${usage.total_requests.toLocaleString()}</div>
                                <div style="color: #cccccc; font-size: 0.9rem;">Total Requests</div>
                            </div>
                            <div style="background: rgba(81, 207, 102, 0.1); border: 1px solid #51cf66; border-radius: 8px; padding: 1rem; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 600; color: #51cf66;">${usage.requests_today.toLocaleString()}</div>
                                <div style="color: #cccccc; font-size: 0.9rem;">Requests Today</div>
                            </div>
                            <div style="background: rgba(255, 199, 95, 0.1); border: 1px solid #ffc75f; border-radius: 8px; padding: 1rem; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 600; color: #ffc75f;">${usage.average_requests_per_day.toLocaleString()}</div>
                                <div style="color: #cccccc; font-size: 0.9rem;">Avg/Day</div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <h4 style="color: #0acff2; margin-bottom: 1rem;">📈 Rate Limiting</h4>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Rate Limit:</span>
                                <span style="color: #51cf66;">${usage.rate_limit_per_hour.toLocaleString()}/hour</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Remaining:</span>
                                <span style="color: #51cf66;">${usage.rate_limit_remaining.toLocaleString()}</span>
                            </div>
                            <div style="background: rgba(51, 207, 102, 0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #51cf66; height: 100%; width: ${(usage.rate_limit_remaining / usage.rate_limit_per_hour * 100)}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem;">
                            <h4 style="color: #0acff2; margin-bottom: 1rem;">📅 Last 7 Days</h4>
                            <div style="display: grid; gap: 0.5rem;">
                                ${usage.last_7_days.map(day => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                        <span>${new Date(day.date).toLocaleDateString()}</span>
                                        <span style="color: #0acff2; font-weight: 600;">${day.requests.toLocaleString()} requests</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); color: #cccccc; font-size: 0.9rem;">
                            <strong>Created:</strong> ${new Date(usage.created_at).toLocaleString()}<br>
                            <strong>Last Used:</strong> ${usage.last_used ? new Date(usage.last_used).toLocaleString() : 'Never'}
                        </div>
                    `;
                } else {
                    document.getElementById('usage-content').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #ff6b6b;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">❌</div>
                            <div>Failed to load usage analytics</div>
                            <div style="font-size: 0.9rem; color: #cccccc; margin-top: 0.5rem;">${data.error ? data.error.message : 'Unknown error'}</div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading usage analytics:', error);
                document.getElementById('usage-content').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ff6b6b;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">❌</div>
                        <div>Error loading usage analytics</div>
                    </div>
                `;
            });
        }

        function closeUsageModal(event) {
            // If event is provided, only close if clicking on the backdrop (not the modal content)
            if (event && event.target !== event.currentTarget) {
                return;
            }
            
            const modal = document.getElementById('usageAnalyticsModal');
            if (modal) {
                modal.remove();
            }
        }

        function manageIPWhitelist(projectId, keyId, keyName) {
            const token = localStorage.getItem('nexuspay_token');
            
            // Show loading modal
            const modal = document.createElement('div');
            modal.id = 'ipWhitelistModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="closeIPWhitelistModal(event)">
                    <div style="background: #1a1a1a; border: 2px solid #0acff2; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="color: #0acff2; margin: 0;">🛡️ IP Whitelist: ${keyName}</h3>
                            <button onclick="closeIPWhitelistModal()" style="background: #0acff2; color: black; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer;">✕ Close</button>
                        </div>
                        <div id="ip-whitelist-content" style="color: #ffffff;">
                            <div style="text-align: center; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
                                <div>Loading IP whitelist...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load current IP whitelist
            fetch(`/api/projects/${projectId}/api-keys/${keyId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const apiKey = data.data.api_key;
                    const whitelist = apiKey.ip_whitelist || [];
                    
                    document.getElementById('ip-whitelist-content').innerHTML = `
                        <div style="margin-bottom: 1.5rem;">
                            <div style="color: #cccccc; margin-bottom: 1rem;">
                                Add IP addresses or CIDR ranges (e.g., 192.168.1.1 or 192.168.1.0/24) that are allowed to use this API key.
                                Leave empty to allow access from any IP address.
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <input type="text" id="newIPInput" placeholder="Enter IP address or CIDR range" 
                                       style="flex: 1; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid #0acff2; border-radius: 4px; color: #ffffff;">
                                <button onclick="addIPToWhitelist('${projectId}', '${keyId}')" 
                                        style="background: #0acff2; color: black; border: none; border-radius: 4px; padding: 0.5rem 1rem; cursor: pointer;">
                                    ➕ Add
                                </button>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem;">
                            <h4 style="color: #0acff2; margin-bottom: 1rem;">📋 Current Whitelist (${whitelist.length} entries)</h4>
                            <div id="whitelist-entries">
                                ${whitelist.length > 0 ? whitelist.map((ip, index) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px; margin-bottom: 0.5rem;">
                                        <span style="font-family: 'Courier New', monospace; color: #51cf66;">${ip}</span>
                                        <button onclick="removeIPFromWhitelist('${projectId}', '${keyId}', '${ip}')" 
                                                style="background: #ff6b6b; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.8rem;">
                                            🗑️ Remove
                                        </button>
                                    </div>
                                `).join('') : '<div style="text-align: center; color: #cccccc; padding: 1rem;">No IP restrictions - API key can be used from any IP address</div>'}
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(255, 199, 95, 0.1); border: 1px solid #ffc75f; border-radius: 8px; color: #ffc75f; font-size: 0.9rem;">
                            ⚠️ <strong>Security Note:</strong> IP whitelisting adds an extra layer of security. Only requests from whitelisted IP addresses will be accepted.
                            Make sure to include all necessary IP addresses before saving.
                        </div>
                    `;
                } else {
                    document.getElementById('ip-whitelist-content').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #ff6b6b;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">❌</div>
                            <div>Failed to load IP whitelist</div>
                            <div style="font-size: 0.9rem; color: #cccccc; margin-top: 0.5rem;">${data.error ? data.error.message : 'Unknown error'}</div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading IP whitelist:', error);
                document.getElementById('ip-whitelist-content').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ff6b6b;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">❌</div>
                        <div>Error loading IP whitelist</div>
                    </div>
                `;
            });
        }

        function addIPToWhitelist(projectId, keyId) {
            const ipInput = document.getElementById('newIPInput');
            const ipAddress = ipInput.value.trim();
            
            if (!ipAddress) {
                alert('Please enter an IP address or CIDR range');
                return;
            }
            
            // Basic IP validation
            const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?:\/[0-9]{1,2})?$/;
            if (!ipRegex.test(ipAddress)) {
                alert('Please enter a valid IP address or CIDR range (e.g., 192.168.1.1 or 192.168.1.0/24)');
                return;
            }
            
            const token = localStorage.getItem('nexuspay_token');
            
            fetch(`/api/projects/${projectId}/api-keys/${keyId}/whitelist`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    ip: ipAddress
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    ipInput.value = '';
                    // Reload the whitelist
                    manageIPWhitelist(projectId, keyId, 'API Key');
                } else {
                    alert(`Failed to add IP to whitelist: ${data.error ? data.error.message : 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error adding IP to whitelist:', error);
                alert('Error adding IP to whitelist');
            });
        }

        function removeIPFromWhitelist(projectId, keyId, ipAddress) {
            if (!confirm(`Remove ${ipAddress} from the whitelist?`)) {
                return;
            }
            
            const token = localStorage.getItem('nexuspay_token');
            
            fetch(`/api/projects/${projectId}/api-keys/${keyId}/whitelist`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    ip: ipAddress
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the whitelist
                    manageIPWhitelist(projectId, keyId, 'API Key');
                } else {
                    alert(`Failed to remove IP from whitelist: ${data.error ? data.error.message : 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error removing IP from whitelist:', error);
                alert('Error removing IP from whitelist');
            });
        }

        function closeIPWhitelistModal(event) {
            // If event is provided, only close if clicking on the backdrop (not the modal content)
            if (event && event.target !== event.currentTarget) {
                return;
            }
            
            const modal = document.getElementById('ipWhitelistModal');
            if (modal) {
                modal.remove();
            }
        }

        function manageProjectSettings(projectId, projectName) {
            const token = localStorage.getItem('nexuspay_token');
            
            // Show loading modal
            const modal = document.createElement('div');
            modal.id = 'projectSettingsModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="closeProjectSettingsModal(event)">
                    <div style="background: #1a1a1a; border: 2px solid #0acff2; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="color: #0acff2; margin: 0;">⚙️ Project Settings: ${projectName}</h3>
                            <button onclick="closeProjectSettingsModal()" style="background: #0acff2; color: black; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer;">✕ Close</button>
                        </div>
                        <div id="project-settings-content" style="color: #ffffff;">
                            <div style="text-align: center; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
                                <div>Loading project settings...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load current project settings
            fetch(`/api/projects/${projectId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const project = data.data.project;
                    
                    document.getElementById('project-settings-content').innerHTML = `
                        <form id="projectSettingsForm" onsubmit="updateProjectSettings('${projectId}', event)" style="display: grid; gap: 1.5rem;">
                            
                            <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem;">
                                <h4 style="color: #0acff2; margin-bottom: 1rem;">📝 Project Information</h4>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; color: #cccccc;">Project Name</label>
                                    <input type="text" id="projectName" value="${project.name}" required
                                           style="width: 100%; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid #0acff2; border-radius: 4px; color: #ffffff;">
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; color: #cccccc;">Description</label>
                                    <textarea id="projectDescription" rows="3" placeholder="Optional project description"
                                              style="width: 100%; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid #0acff2; border-radius: 4px; color: #ffffff; resize: vertical;">${project.description || ''}</textarea>
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; color: #cccccc;">Website URL</label>
                                    <input type="url" id="projectWebsite" value="${project.website || ''}" placeholder="https://example.com"
                                           style="width: 100%; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid #0acff2; border-radius: 4px; color: #ffffff;">
                                </div>
                            </div>
                            
                            <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem;">
                                <h4 style="color: #0acff2; margin-bottom: 1rem;">⛓️ Blockchain Settings</h4>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; color: #cccccc;">Supported Chains</label>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem;">
                                        ${['ethereum', 'arbitrum', 'solana', 'polygon', 'optimism', 'base'].map(chain => `
                                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px; cursor: pointer;">
                                                <input type="checkbox" name="chains" value="${chain}" ${project.chains && project.chains.includes(chain) ? 'checked' : ''}
                                                       style="margin: 0;">
                                                <span style="text-transform: capitalize; font-size: 0.9rem;">${chain}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem;">
                                <h4 style="color: #0acff2; margin-bottom: 1rem;">🔧 Advanced Settings</h4>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="paymasterEnabled" ${project.settings?.paymasterEnabled !== false ? 'checked' : ''}
                                               style="margin: 0;">
                                        <span>Enable Paymaster (Gas Sponsorship)</span>
                                    </label>
                                    <div style="font-size: 0.8rem; color: #cccccc; margin-top: 0.25rem; margin-left: 1.5rem;">
                                        When enabled, the project can sponsor gas fees for user transactions
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="analyticsEnabled" ${project.settings?.analyticsEnabled !== false ? 'checked' : ''}
                                               style="margin: 0;">
                                        <span>Enable Analytics & Monitoring</span>
                                    </label>
                                    <div style="font-size: 0.8rem; color: #cccccc; margin-top: 0.25rem; margin-left: 1.5rem;">
                                        Track API usage, transaction volumes, and performance metrics
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; color: #cccccc;">Rate Limiting (requests per hour)</label>
                                    <select id="rateLimitTier" style="width: 100%; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid #0acff2; border-radius: 4px; color: #ffffff;">
                                        <option value="basic" ${project.settings?.rateLimitTier === 'basic' ? 'selected' : ''}>Basic (1,000/hour)</option>
                                        <option value="standard" ${project.settings?.rateLimitTier === 'standard' ? 'selected' : ''}>Standard (5,000/hour)</option>
                                        <option value="premium" ${project.settings?.rateLimitTier === 'premium' ? 'selected' : ''}>Premium (10,000/hour)</option>
                                        <option value="enterprise" ${project.settings?.rateLimitTier === 'enterprise' ? 'selected' : ''}>Enterprise (50,000/hour)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" onclick="closeProjectSettingsModal()" 
                                        style="background: rgba(255,255,255,0.1); color: #ffffff; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 0.75rem 1.5rem; cursor: pointer;">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        style="background: #0acff2; color: black; border: none; border-radius: 6px; padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 600;">
                                    💾 Save Settings
                                </button>
                            </div>
                        </form>
                        
                        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; color: #cccccc; font-size: 0.9rem;">
                                <span>Project ID: <code style="background: rgba(255,255,255,0.1); padding: 0.2rem 0.5rem; border-radius: 3px;">${projectId}</code></span>
                                <span>Created: ${new Date(project.createdAt || project.created_at).toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('project-settings-content').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #ff6b6b;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">❌</div>
                            <div>Failed to load project settings</div>
                            <div style="font-size: 0.9rem; color: #cccccc; margin-top: 0.5rem;">${data.error ? data.error.message : 'Unknown error'}</div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading project settings:', error);
                document.getElementById('project-settings-content').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ff6b6b;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">❌</div>
                        <div>Error loading project settings</div>
                    </div>
                `;
            });
        }

        function updateProjectSettings(projectId, event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const selectedChains = Array.from(document.querySelectorAll('input[name="chains"]:checked')).map(cb => cb.value);
            
            const updateData = {
                name: document.getElementById('projectName').value.trim(),
                description: document.getElementById('projectDescription').value.trim(),
                website: document.getElementById('projectWebsite').value.trim(),
                chains: selectedChains,
                settings: {
                    paymasterEnabled: document.getElementById('paymasterEnabled').checked,
                    analyticsEnabled: document.getElementById('analyticsEnabled').checked,
                    rateLimitTier: document.getElementById('rateLimitTier').value
                }
            };
            
            if (!updateData.name) {
                alert('Project name is required');
                return;
            }
            
            if (selectedChains.length === 0) {
                alert('Please select at least one blockchain');
                return;
            }
            
            const token = localStorage.getItem('nexuspay_token');
            
            fetch(`/api/projects/${projectId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Project settings updated successfully!');
                    closeProjectSettingsModal();
                    // Reload the dashboard to show updated settings
                    loadAllPaymasterData();
                } else {
                    alert(`Failed to update project settings: ${data.error ? data.error.message : 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error updating project settings:', error);
                alert('Error updating project settings');
            });
        }

        function closeProjectSettingsModal(event) {
            // If event is provided, only close if clicking on the backdrop (not the modal content)
            if (event && event.target !== event.currentTarget) {
                return;
            }
            
            const modal = document.getElementById('projectSettingsModal');
            if (modal) {
                modal.remove();
            }
        }

        // ==================== CHAIN MANAGEMENT FUNCTIONS ==================== //

        /**
         * Load chains for project creation form
         */
        function loadChainsForProjectForm() {
            fetch('/api/chains', {
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.chains) {
                    const checkboxGroup = document.getElementById('chainsCheckboxGroup');
                    const chains = data.data.chains;
                    
                    checkboxGroup.innerHTML = chains.map(chain => `
                        <label class="checkbox-label">
                            <input type="checkbox" name="chains" value="${chain.id}"> 
                            ${chain.displayName || chain.name} ${chain.isTestnet ? '(Testnet)' : ''}
                        </label>
                    `).join('');
                } else {
                    document.getElementById('chainsCheckboxGroup').innerHTML = `
                        <div style="color: #ff6b6b; font-size: 0.9rem;">Failed to load available chains</div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading chains for form:', error);
                document.getElementById('chainsCheckboxGroup').innerHTML = `
                    <div style="color: #ff6b6b; font-size: 0.9rem;">Error loading chains</div>
                `;
            });
        }

        /**
         * Load and display all supported chains
         */
        function loadSupportedChains() {
            fetch('/api/chains', {
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySupportedChains(data.data.chains);
                    updateChainStatistics(data.data.chains);
                } else {
                    document.getElementById('currentChainsList').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #ff6b6b;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">❌</div>
                            <div>Failed to load chains</div>
                            <div style="font-size: 0.9rem; color: #cccccc; margin-top: 0.5rem;">${data.error ? data.error.message : 'Unknown error'}</div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading chains:', error);
                document.getElementById('currentChainsList').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ff6b6b;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">❌</div>
                        <div>Error loading chains</div>
                    </div>
                `;
            });
        }

        /**
         * Display supported chains in the UI
         */
        function displaySupportedChains(chains) {
            const chainsList = document.getElementById('currentChainsList');
            
            if (!chains || chains.length === 0) {
                chainsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #888;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">⛓️</div>
                        <div>No chains configured</div>
                    </div>
                `;
                return;
            }

            chainsList.innerHTML = chains.map(chain => `
                <div class="chain-card">
                    <div class="chain-header">
                        <div class="chain-name">${chain.displayName || chain.name}</div>
                        <div class="chain-type ${chain.type.toLowerCase()}">${chain.type}</div>
                    </div>
                    
                    <div class="chain-details">
                        <div class="chain-detail">
                            <span class="chain-detail-label">Chain ID:</span>
                            <span class="chain-detail-value">${chain.chainId}</span>
                        </div>
                        <div class="chain-detail">
                            <span class="chain-detail-label">Currency:</span>
                            <span class="chain-detail-value">${chain.currency}</span>
                        </div>
                        <div class="chain-detail">
                            <span class="chain-detail-label">Network:</span>
                            <span class="chain-detail-value">${chain.isTestnet ? 'Testnet' : 'Mainnet'}</span>
                        </div>
                        <div class="chain-detail">
                            <span class="chain-detail-label">Explorer:</span>
                            <span class="chain-detail-value">
                                ${chain.explorerUrl ? `<a href="${chain.explorerUrl}" target="_blank" style="color: #0acff2;">View</a>` : 'Not configured'}
                            </span>
                        </div>
                    </div>

                    <div class="chain-features">
                        ${chain.features?.accountAbstraction ? '<span class="chain-feature">Account Abstraction</span>' : ''}
                        ${chain.features?.paymasterSupport ? '<span class="chain-feature">Paymaster Support</span>' : ''}
                        ${chain.features?.crossChainBridge ? '<span class="chain-feature">Cross-Chain Bridge</span>' : ''}
                        ${chain.features?.layer2 ? '<span class="chain-feature">Layer 2</span>' : ''}
                    </div>
                </div>
            `).join('');
        }

        /**
         * Update chain statistics display
         */
        function updateChainStatistics(chains) {
            const total = chains.length;
            const evm = chains.filter(c => c.type === 'EVM').length;
            const svm = chains.filter(c => c.type === 'SVM').length;
            const testnet = chains.filter(c => c.isTestnet).length;

            document.getElementById('totalChains').textContent = total;
            document.getElementById('evmChains').textContent = evm;
            document.getElementById('svmChains').textContent = svm;
            document.getElementById('testnetChains').textContent = testnet;
        }

        /**
         * Show add chain modal
         */
        function showAddChainModal() {
            document.getElementById('addChainModal').style.display = 'block';
            
            // Clear any previous errors/success messages
            document.getElementById('addChainError').style.display = 'none';
            document.getElementById('addChainSuccess').style.display = 'none';
            
            // Reset the form
            document.getElementById('addChainForm').reset();
        }

        /**
         * Close add chain modal
         */
        function closeAddChainModal() {
            document.getElementById('addChainModal').style.display = 'none';
        }

        /**
         * Show error message for add chain form
         */
        function showAddChainError(message) {
            const errorDiv = document.getElementById('addChainError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        /**
         * Show success message for add chain form
         */
        function showAddChainSuccess(message) {
            const successDiv = document.getElementById('addChainSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        // Add chain form handling
        document.getElementById('addChainForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const chainId = document.getElementById('newChainId').value.trim().toLowerCase();
            const chainType = document.getElementById('newChainType').value;
            const name = document.getElementById('newChainName').value.trim();
            const currency = document.getElementById('newChainCurrency').value.trim().toUpperCase();
            const rpcUrl = document.getElementById('newChainRpc').value.trim();
            const chainIdNumber = parseInt(document.getElementById('newChainIdNumber').value);
            const explorerUrl = document.getElementById('newChainExplorer').value.trim();
            
            // Validation
            if (!chainId || !chainType || !name || !currency || !rpcUrl || !chainIdNumber) {
                showAddChainError('Please fill in all required fields');
                return;
            }
            
            if (!/^[a-z0-9_-]+$/.test(chainId)) {
                showAddChainError('Chain ID can only contain lowercase letters, numbers, underscores, and hyphens');
                return;
            }
            
            const btn = document.getElementById('addChainBtn');
            btn.disabled = true;
            btn.textContent = '⏳ Adding Chain...';
            
            const token = localStorage.getItem('nexuspay_token');
            
            const newChainData = {
                chainId,
                name,
                type: chainType,
                rpcUrl,
                chainIdNumber,
                currency,
                explorerUrl: explorerUrl || undefined
            };
            
            fetch('/api/chains', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(newChainData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAddChainSuccess(`✅ Chain '${name}' added successfully! Check the instructions for next steps.`);
                    
                    // Show deployment instructions
                    setTimeout(() => {
                        alert(`🎉 Chain Added Successfully!

${name} (${chainId}) has been added to NexusPay.

📋 Next Steps:
1. Deploy EntryPoint contract on ${name}
2. Deploy WalletFactory contract on ${name}  
3. Deploy Paymaster contract on ${name}
4. Update chain configuration with contract addresses
5. Test wallet creation and deployment
6. Update project models to include ${chainId}

💡 The chain is now available for selection in new projects!`);
                    }, 1000);
                    
                    document.getElementById('addChainForm').reset();
                    loadSupportedChains(); // Reload chains list
                    
                } else {
                    showAddChainError(data.error ? data.error.message : 'Failed to add chain');
                }
            })
            .catch(error => {
                console.error('Error adding chain:', error);
                showAddChainError('Network error occurred');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = '⛓️ Add Chain';
            });
        });

        // Analytics Functions
        function populateAnalyticsProjects() {
            const projectSelect = document.getElementById('analyticsProject');
            projectSelect.innerHTML = '<option value="">Select Project</option>';
            
            userProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id || project.project_id;
                option.textContent = project.name;
                projectSelect.appendChild(option);
            });
        }

        function loadProjectAnalytics() {
            const projectId = document.getElementById('analyticsProject').value;
            const period = document.getElementById('analyticsPeriod').value;
            
            if (!projectId) {
                document.getElementById('analyticsContent').innerHTML = `
                    <div class="analytics-loading">
                        <div class="loading-spinner"></div>
                        <p>Select a project to view analytics...</p>
                    </div>
                `;
                return;
            }

            document.getElementById('analyticsContent').innerHTML = `
                <div class="analytics-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading analytics data...</p>
                </div>
            `;

            const token = localStorage.getItem('nexuspay_token');
            
                         Promise.all([
                 fetch(`/api/projects/${projectId}/analytics/overview?days=${period}`, {
                     headers: { 'Authorization': `Bearer ${token}` }
                 }),
                 fetch(`/api/projects/${projectId}/analytics/transactions?limit=10`, {
                     headers: { 'Authorization': `Bearer ${token}` }
                 }),
                 fetch(`/api/projects/${projectId}/analytics/costs?days=${period}`, {
                     headers: { 'Authorization': `Bearer ${token}` }
                 }),
                 fetch(`/api/projects/${projectId}/analytics/users`, {
                     headers: { 'Authorization': `Bearer ${token}` }
                 })
             ])
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(([overview, transactions, costs, users]) => {
                displayAnalyticsData({ overview, transactions, costs, users });
            })
            .catch(error => {
                console.error('Error loading analytics:', error);
                document.getElementById('analyticsContent').innerHTML = `
                    <div class="analytics-loading">
                        <p style="color: #ef4444;">Failed to load analytics data. Please try again.</p>
                    </div>
                `;
            });
        }

        function displayAnalyticsData(data) {
            const content = document.getElementById('analyticsContent');
            
            const overview = data.overview.success ? data.overview.data.overview : {};
            const chains = data.overview.success ? data.overview.data.chains : {};
            const transactionHistory = data.transactions.success ? data.transactions.data.transactions : [];
            const costData = data.costs.success ? data.costs.data.costs : {};
            const userData = data.users.success ? data.users.data : {};

            content.innerHTML = `
                <!-- Analytics Overview Cards -->
                <div class="analytics-overview">
                    <div class="analytics-card">
                        <div class="analytics-value">${overview.total_transactions || 0}</div>
                        <div class="analytics-label">Total Transactions</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value">${overview.total_unique_users || 0}</div>
                        <div class="analytics-label">Unique Users</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value">$${(costData.total_spent_usd || 0).toFixed(2)}</div>
                        <div class="analytics-label">Total Gas Spent</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value">${costData.paymaster_coverage_pct || 0}%</div>
                        <div class="analytics-label">Paymaster Coverage</div>
                    </div>
                </div>

                <!-- Cost Breakdown -->
                <div class="analytics-table">
                    <h4>💰 Cost Analysis</h4>
                    <div class="cost-breakdown">
                        <div class="cost-item">
                            <div class="cost-value">$${(costData.total_spent_usd || 0).toFixed(2)}</div>
                            <div class="cost-label">Total Spent</div>
                        </div>
                        <div class="cost-item">
                            <div class="cost-value">$${(costData.paymaster_spent_usd || 0).toFixed(2)}</div>
                            <div class="cost-label">Paymaster Covered</div>
                        </div>
                        <div class="cost-item">
                            <div class="cost-value">$${(costData.user_paid_usd || 0).toFixed(2)}</div>
                            <div class="cost-label">User Paid</div>
                        </div>
                        <div class="cost-item">
                            <div class="cost-value">$${data.costs.success && data.costs.data.forecast ? (data.costs.data.forecast.next_30d_estimate_usd || 0).toFixed(2) : '0.00'}</div>
                            <div class="cost-label">30-Day Forecast</div>
                        </div>
                    </div>
                </div>

                <!-- Chain Breakdown -->
                <div class="analytics-charts">
                    <div class="analytics-chart">
                        <h4>⛓️ Activity by Chain</h4>
                        <div class="data-table" style="font-size: 0.9rem;">
                            ${Object.keys(chains).length > 0 ? Object.entries(chains).map(([chain, data]) => `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <span style="text-transform: capitalize; font-weight: 600;">${chain}</span>
                                    <span>${data.transactions || 0} txns</span>
                                </div>
                            `).join('') : '<div style="text-align: center; color: #888; padding: 1rem;">No chain data available</div>'}
                        </div>
                    </div>

                    <div class="analytics-chart">
                        <h4>👥 Top Users</h4>
                        <div class="data-table" style="font-size: 0.9rem;">
                            ${userData.top_users && userData.top_users.length > 0 ? userData.top_users.slice(0, 5).map(user => `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <span style="font-family: monospace; font-size: 0.8rem;">${user.user_identifier?.substring(0, 20)}...</span>
                                    <span>${user.transactions_count || 0} txns</span>
                                </div>
                            `).join('') : '<div style="text-align: center; color: #888; padding: 1rem;">No user data available</div>'}
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="analytics-table">
                    <h4>📊 Recent Transactions</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Chain</th>
                                <th>User</th>
                                <th>Gas Cost</th>
                                <th>Paymaster</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transactionHistory.length > 0 ? transactionHistory.map(tx => `
                                <tr>
                                    <td>${new Date(tx.createdAt).toLocaleDateString()}</td>
                                    <td style="text-transform: capitalize;">${(tx.transaction_type || '').replace('_', ' ')}</td>
                                    <td style="text-transform: capitalize;">${tx.chain}</td>
                                    <td style="font-family: monospace; font-size: 0.8rem;">${(tx.user_identifier || '').substring(0, 15)}...</td>
                                    <td>$${(tx.gas_cost_usd || 0).toFixed(4)}</td>
                                    <td>${tx.paymaster_paid ? '✅ Yes' : '❌ No'}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="6" style="text-align: center; color: #888;">No transactions found</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function exportAnalytics() {
            const projectId = document.getElementById('analyticsProject').value;
            const period = document.getElementById('analyticsPeriod').value;
            
            if (!projectId) {
                alert('Please select a project first');
                return;
            }

            const token = localStorage.getItem('nexuspay_token');
            
            // Show export options
            const exportChoice = confirm('Export as CSV? (Cancel for JSON)');
            const format = exportChoice ? 'csv' : 'json';
            
                         fetch(`/api/projects/${projectId}/analytics/export?format=${format}&type=transactions&period=${period}d`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create download
                    const blob = new Blob([data.data.data], { 
                        type: data.data.contentType 
                    });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.data.filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Export failed: ' + (data.error?.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Export error:', error);
                alert('Export failed. Please try again.');
            });
        }

        // Load analytics projects when tab is shown
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load specific tab data
            if (tabName === 'chains') {
                loadSupportedChains();
            } else if (tabName === 'create') {
                loadChainsForProjectForm();
            } else if (tabName === 'analytics') {
                populateAnalyticsProjects();
            }
        }
    </script>
</body>
</html> 